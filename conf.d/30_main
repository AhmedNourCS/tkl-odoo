#!/bin/sh -ex

#
# START - Install Odoo - 30_main
#
 
# Set variables

DB_NAME=openerp
DB_USER=openerp
DB_PASS=$(mcookie)
SERVICE_USER=openerp

OPENERP_PASS=openerp
OPENERP_DIR=/opt/openerp
ODOO_DIR=/opt/openerp/odoo
ODOO_DIR_TMP=/opt/openerp/odoo_tmp


# Create database and database role for odoo
# 

# Start postgresql server
/etc/init.d/postgresql start

# Create db user
su postgres -c "createuser --no-superuser --createdb --no-createrole $DB_USER"

# Create database
su postgres -c "createdb --owner $DB_USER -EUTF8 $DB_NAME"

# Set db user password
su postgres -c "psql postgres" << EOF
alter user $DB_USER with encrypted password '$DB_PASS';
EOF

# Stop postgresql server
/etc/init.d/postgresql stop
# 



# Add service account user
#

# Add user without home dir
useradd -M $SERVICE_USER 

# Set no shell
usermod -s /bin/false $SERVICE_USER

# Disable user
usermod -L $SERVICE_USER 

# Not sure what this line is doing, looks like setting password? 
# should not need a password for service account. Leaving this 
# in case there is a reason I don't understand
 
# usermod -p $(echo $OPENERP_PASS | openssl passwd -1 -stdin) openerp
#


# Install Odoo
# 
git clone https://github.com/odoo/odoo.git --branch 8.0 --depth=1  $ODOO_DIR 

# May want to do the following to save some space
# rm -rf .git to remove

chown -R openerp:openerp $ODOO_DIR
mv $ODOO_DIR_TMP/* $ODOO_DIR
rm -rf $ODOO_DIR_TMP
# 


# Install Odoo as a service
# 

chmod 666 /opt/openerp/openerp.init 
chmod +x /opt/openerp/openerp.init
cd /etc/init.d
ln -s $OPENERP_DIR/openerp.init openerp-server
update-rc.d openerp-server defaults
touch /var/log/openerp-server.log
chown openerp /var/log/openerp-server.log
touch /var/run/openerp-server.pid
chown openerp /var/run/openerp-server.pid
chown -R openerp:openerp $ODOO_DIR
# 


# Perform apache config		
# Enable needed modules
# 
a2enmod ssl proxy_http headers rewrite		

# Enable sites
a2ensite openerp-ssl.conf		
a2ensite odoo-80.conf		
a2ensite odoo-12325.conf		

# odoo-12325.conf also creates port 12324 for SSL		
# Port 12324 for SSL

